Installation & Configuration
----------------------------

  This component requires ([EB Command Line Tools 3.x](http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb-cli3-getting-set-up.html)) and boto.

    # Make sure setup tools are upto date
	pip install --upgrade setuptools
	
	# Install EB Command Line Tools
	pip install awsebcli
	
	# Install boto
	pip install boto

    # Configure AWS parameters in `setup_env.sh` file
	#Set to location of eb tools downloaded. You need to point to the eb executable for your platform. Example:
	export EB="/<parent-directory>/eb/macosx/python2.7/eb"
	export AWS_REPO_SETUP="/<parent-directory>/AWSDevTools/Linux/AWSDevTools-RepositorySetup.sh"

	#Set AWS access key. Can be generated by following instructions under Access keys:
	# http://docs.aws.amazon.com/general/latest/gr/getting-aws-sec-creds.html
	export AWS_ACCESS_KEY_ID="<Access Key>"
	export AWS_SECRET_ACCESS_KEY="<Access Key Secret>"

	#Set region from one of these keys: http://docs.aws.amazon.com/general/latest/gr/rande.html#elasticbeanstalk_region
	export AWS_DEFAULT_REGION="us-east-1"

	#Set defined variables in current shell
	source setup_env.sh


Please note that `source setup_env.sh` command needs to be run on every new terminal window opened.

Architecture
------------

The master thread queues operations to a single request queue. Example of this can be found in `server/src/parallel.py`

	# Imports
	import boto.sqs
	from boto.sqs.message import Message

	# Connect to AWS region.
	conn = boto.sqs.connect_to_region( os.environ['AWS_DEFAULT_REGION'] )
    
	# Get the optima queue. We will error out if no queue is found. This is what is desired.
	optima_queue = conn.get_all_queues( os.environ['AWS_WORKER_QUEUE_PREFIX'] )
	optima_queue = optima_queue[0]

    # A new queue to get response from all slave workers. Needs to be unique across all api calls
    response_queue_id = id_generator()
    q=conn.create_queue(response_queue_id)

    # Prepate a new message
    m = Message()
    m.set_body( json.dumps({'action': 'addition', 'iteration': i, 'parameter': someparameter, 'responseq': response_queue_id } ) )

    # Write to the queue
    optima_queue.write( m )

We will need to capture responses from all workers:

    result = []
    for i in range( nprocesses ):
        # We expect the process to complete in 3 minutes or less
        rs = q.get_messages(num_messages=1, wait_time_seconds=20)
        
        if ( len(rs) > 0 ):
            m = rs[0]
            resp = json.loads( m.get_body() )
            q.delete_message(m)
        
            result.append(resp['output'])
   
    # We are done, delete response q
    q.delete()   

All slave instances run `server/src/worker.py`. New messages are posted to the root `/` Based on action, worker threads can perform different computation.

Development Environment
-----------------------

To facilitate development, but without having to continually publish to AWS for testing parallel execution, a local development environment can be setup. Use the steps described below to set it up. 

You need to create a new SQS queue with a unique name that will be used during development. This ensures that your queue does not conflict with existing queues used on production or by other developers. Visit this link to setup the queue: https://console.aws.amazon.com/sqs/home?region=us-west-2

The environment variable `AWS_WORKER_QUEUE_PREFIX` needs to be set to the name of the queue created. This can be done by setting the statement in `setup_env.sh` and invoking it using `source setup_env.sh`.

If the API server is now started (using `./run.sh` in `server` directory), it will push worker tasks to the new queue.

The `worker/eb_sim.sh` is a Elastic Beanstalk simulation tool that pulls messages from queue defined in `AWS_WORKER_QUEUE_PREFIX` and posts them in an HTTP post to the worker thread. This behavior is similar to how Elatic Beanstalk behaves on AWS. This tool needs to be run during development.

Finally, `python server/src/worker.py` needs to be started to receive post messages.

Setup an EB Application
------------------------

    # Run setup from parent directory of local git repository
	./worker/run.sh --init
	
	...
	# Enter Access key and secret 
	You have not yet set up your credentials or your credentials are incorrect 
	You must provide your credentials.
	(aws-access-id):
	(aws-secret-key):
	...
	...
	


Start an EB Environment
-----------------------

    # Run command parent directory of local git repository
	./worker/run.sh --create	



Terminate an EB Environment
---------------------------

    # Run command parent directory of local git repository
	./worker/run.sh --terminate	


Deploy latest code to EB Environment
------------------------------------

    # Run command parent directory of local git repository
	./worker/run.sh --deploy


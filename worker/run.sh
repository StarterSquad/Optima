#!/bin/bash

#TODO: Set to location of eb tools downloaded from here: http://aws.amazon.com/code/6752709412171743
#TODO: Set AWS access key as environment variable. Can be generated by following instructions under Access keys:
# http://docs.aws.amazon.com/general/latest/gr/getting-aws-sec-creds.html
EB_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
EB_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

#TODO: Set region from one of these keys: http://docs.aws.amazon.com/general/latest/gr/rande.html#elasticbeanstalk_region
EB_REGION=${AWS_DEFAULT_REGION}

# Application name
EB_APP_NAME="optima"

# Environment Tier
EB_ENVIRONMENT_TIER="Worker::SQS/HTTP::1.0"

# Solution Stack
EB_SOLUTION_STACK="64bit Amazon Linux 2014.03 v1.0.9 running Python 2.7"

if [ -n "${EB}" ]; then
	
	if [ "${1}" = "--setup" ]; then
		
		if [ -n "${EB_ACCESS_KEY_ID}" ] && [ -n "${EB_SECRET_ACCESS_KEY}" ] && [ -n "${EB_REGION}" ]; then
			echo "Setup EB application"
			${EB} init -I ${EB_ACCESS_KEY_ID} -S ${EB_SECRET_ACCESS_KEY} --region ${EB_REGION} -a ${EB_APP_NAME} -e ${EB_APP_NAME}-env -t "${EB_ENVIRONMENT_TIER}" -s "${EB_SOLUTION_STACK}"
		
			echo "Configuring git"
			${AWS_REPO_SETUP}
			git aws.config
			
		else
			echo "Set the EB_ACCESS_KEY_ID and EB_SECRET_ACCESS_KEY to your AWS access key credentials. Also set EB_REGION to the region to be used"
		fi
		
	elif [ "${1}" = "--start" ]; then
		echo "Run EB application"
		${EB_PATH}/eb start
	elif [ "${1}" = "--stop" ]; then
		echo "Stop EB application"
		${EB_PATH}/eb stop
	elif [ "${1}" = "--delete" ]; then
		echo "Delete EB application"
		${EB_PATH}/eb delete
	elif [ "${1}" = "--branch" ]; then
		echo "Setup EB branch"
		${EB_PATH}/eb branch
	else
		echo "--setup    Setup application"
		echo "--start    Start application"
		echo "--stop     Stop application"
		echo "--delete   Delete application"
		echo "--branch   Prepare EB branch"
	fi
	
else
    echo "Set the EB_PATH to location of AWS Elastic Beanstalk Command Line Tools. Can be downloaded from here: http://aws.amazon.com/code/6752709412171743"
fi

---
  - include: "{{prudentia_dir}}/tasks/python.yml"
    tags: api

  - name: API | Install python dependencies
    pip: requirements={{install_dir_api}}/requirements.txt state=present
    sudo: yes
    tags:
      - api
      - update

  - name: API | Copy API configuration
    template: src={{root_dir}}/components/templates/api-config.py.j2 dest={{install_dir_api}}/src/config.py backup=yes
    tags:
      - api
      - update

  - name: API | Install gunicorn
    pip: name=gunicorn state=present
    sudo: yes
    tags: api

  - name: API | Install Ubuntu packages
    apt: pkg=postgresql-client-9.3 state=present
    sudo: yes
    tags: api

  - name: API | Setup migrations in the database if needed
    shell: if ! psql -U {{db_user}} -h {{db_host}} -d {{db_name}} -c '\d+' | grep migrate_version >/dev/null ; then migrate version_control {{db_url}} {{install_dir}}/server/db/ ; fi
    environment:
      PGPASSWORD: "{{ db_password }}"
    tags: api


  - name: API | Upgrade database
    command: migrate upgrade {{db_url}} {{install_dir}}/server/db/
    tags:
      - api
      - update
      - migrate

  - name: API | Copy upstart script
    template: src={{root_dir}}/components/templates/upstart.conf.j2 dest=/etc/init/optima-api.conf backup=yes
    sudo: yes
    tags:
      - api
      - update

  - name: API | Restart
    service: name=optima-api state=restarted
    sudo: yes
    tags:
      - api
      - update

  - name: API | Pause before migrating
    pause: seconds=5
    tags:
      - api
      - update

  - name: API | Migrate
    shell: curl -XPOST -i http://localhost:5000/api/project/data/migrate/mmm?secret=40a0233e6b155cd08d8f8f4cd3ea85d854af454b334e80f896afff61
    sudo: yes
    tags:
      - api
      - update


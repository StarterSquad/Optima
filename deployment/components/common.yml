---
  # Remember to add the public key as deploy key for this repository
  - include: "{{prudentia_dir}}/tasks/ssh-key.yml ssh_user={{ansible_user_id}} ssh_group={{ansible_user_id}} ssh_dir=/home/{{ansible_user_id}} files_dir={{root_dir}}/components/files/ssh key_name=id_rsa"
    tags: common

  - name: API | Install Ubuntu packages
    apt: pkg={{item}} state=present
    sudo: yes
    with_items:
      - libfreetype6
      - libfreetype6-dev
      - libfontconfig1
      - libfontconfig1-dev
      - pkg-config
      - libblas-dev
      - liblapack-dev
      - gfortran
      - libpq-dev
      - libpng12-dev
    tags: api

  - include: "{{prudentia_dir}}/tasks/github.yml ssh_dir=/home/{{ansible_user_id}}"
    tags: common

  - name: Common | Dump mounts points
    command: /bin/mount
    register: machine_mounts
    tags:
      - common
      - update

  - name: Common | Create directory
    file: dest={{install_dir}} owner={{ansible_user_id}} group={{ansible_user_id}} mode=755 state=directory
    when: "install_dir not in machine_mounts.stdout"
    sudo: yes
    tags: common

  - name: Common | Checkout git repository
    git: repo={{git_repository}} dest={{install_dir}} version={{version}}
    when: "install_dir not in machine_mounts.stdout"
    tags:
      - common
      - update

  - name: Stop application before deploy starts
    service: name=optima-api state=stopped
    when: stop_before_deploy is defined
    ignore_errors: yes
    sudo: yes
    tags:
      - common
      - update
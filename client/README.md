
# Optima 2.0 webclient

- the Optima webclient is a single-page-application written in
  Javascript ES5, using the Angular 1.0 framework.
- the entry point of the developing version of the webclient is `source/index.html`.
- **WARNING**, many of these notes are outdated!

## Building the webclient

First off, here is the script to build the webclient:

- `../bin/build_client.sh` for production in the `build` folder

In these scripts:

- `npm` is used to install all the `node` modules
required to compile the assets required for the webserver.  
- `gulpfile.js` describes all the steps required to build the
  webclient, and the compilation is carried out by `gulp`, a node-based
  task-runner (batch commands, compilation, copying etc.)
- `package.json` lists all the npm modules to download, including
  `gulp` and all the modules that the `gulpfile` requires
- `bower` is used to load modules required in the webclient itself
  and the modules are stored in the `source/vendor` folder
- `bower.json` lists all the third-party modules required
  within the webclient
- there is a hook in `package.json` that runs `bower` to install
  the third-party libraries in `source/vendor`
- the CSS files are written as `sass` files in the `source/sass`
  directory, and are compiled by `gulp-sass`, and
  ultimately placed in the `source/assets/css` folder

## Compiling the webclient

The compilation of the webclient is carried out by [Gulp](http://gulpjs.com/) and is
described in `gulpfile.js`. The different tasks that can be carried out are:

- `gulp` builds client into `build` directory.
- `gulp watch` listens to changes to stylesheets and scripts and reloads browser page during development.
- `gulp bump-version` updates JSON files and `source/index.html` with tagged releases.
- `gulp write-version-js` updates `source/js/version.js` to the latest git version and date
- `gulp copy-assets-and-vendor-js` compiles a single-file version of the webclient in `build`
- `gulp compile-sass` compiles the SASS files in `source/sass` to CSS files in `source/assets/css`.
- `gulp compile-build-js-client-uglify` compiles a single-file version of the webclient in `build`

## Layout of the webclient

- uses the AMD method for loading modules
- uses `angular.bootstrap` for modal dialogs
- uses `toastr` for the notifications
- uses `mpld3` and `d3` to display the graphs exported from matplotlib
- uses `angularjs-slider` for sliders
- uses `font-awesome` for web-icons
- `normalize.css` is used for cross-browser compatibility
- the `sass` files follow the [MCSS](http://operatino.github.io/MCSS/en/) convention
- uses `angular-tooltip` - https://github.com/samiralajmovic/tooltip
- uses `angular-loading-bar` - http://chieffancypants.github.io/angular-loading-bar/

In the `source` folder:

- `source/index.html` is the entry-point into the webclient
- `source/js` holds the javascript files and internal modules
- `source/sass` the SASS files that will be compiled into CSS files
- `source/assets` holds (compiled) CSS files, images and icons
- `source/vendor` stores third-party libraries used in the webclient such as angular

In the `source/js` folder:

- `app.js` the entry point of the Angular app where all modules are loaded
- `main.js` the main loading point, with pre-loading hooks
- `config.js` is the loading point of all modules, vendor and internal
- `version.js` (which is automatically generated by gulp) lists the current git branch and commit date, to be displayed in the help page
- the `modules` folder:
    - `admin` handles administrator user and projects views
    - `analysis` scenario and optimization pages
    - `calibration` the calibration page
    - `charts` directives, services and libraries to render graphs
    - `common` utility functions and directives
      - `form-input-validate-directive` stores/extracts active project from local storage
      - `icon-directive` stores/extracts active project from local storage
      - `local-storage-polyfill` stores/extracts active project from local storage
      - `poller-service` sores/extracts users from webserver
      - `project-service` sores/extracts projects from webserver
      - `rpc-service` sores/extracts users from webserver
    - `costfunction` the geospatial analysis
    - `geospatial` the geospatial analysis
    - `optimization` the geospatial analysis
    - `programs` program set and cost functions page
    - `project` project management (home), project edit/populations, and population modal dialog, and some services
    - `scenarios` program set and cost functions page
    - `ui` menu items and common modal dialogs
    - `user` user manager and user-api services, login, register, and user-edit pages

## Modifying the webclient

Note: changes are easier with a proper IDE like Webstorm.

## Beginner's Guide to Angular

The client is written in the Angular 1 framework, using the require.js
module system. A good start is to read the [Angular 1 Style Guide](https://github.com/johnpapa/angular-styleguide/blob/master/a1/README.md)

Here are some basic concepts.

There are three ways of dealing with modules within the app, and all three must be understood to correctly interact app:

1. `require.js` is a method of loading modules. This is what the `require` and `define` functions refer to. `define` is used to register modules within the `require.js` eco-system, and to list dependencies that `require.js` will handle.
2. angular modules are defined, and recalled, by the angular `angular.module` function. Once the modules are loaded, all defined states/controllers/directives/services are now accessible to any controllers you define, and are accessed through parameter injection.
3. angular services, which are defined by `module.service` or `module.factory` are injected modules. Once the module that define the services are loaded, any other angular object can access the services by including the service in the function parameter.

As currently written, when an angular module is instantiated in a require.js module, the angular module is returned, thus the require.js module can also be used to directly access the angular module. This actually mixes up the two module systems, where, otherwise, the angular module should be accessible via the `angular.module` function calling convention.

### modules

For clarity, it's better not to chain module declaration and defining 
states/controllers/directives/services together. Track the modules via a module variable. As much as possible, angular module loading is done on a per file basis,
so that there are no complex loading of an angular module from
multiple files.

In Angular, the key elements are:

  - states - define pages, w.r.t. to the pseudo-url (part after the #),
    these work with `ui.router` and work through the $stateProvider
    service
  - controllers - they are tied to DOM elements/tags, or pages via states
  - directives - custom-defined tag elements in HTML
  - services/factory - effective modules for code/data
    that can be injected into any controller. The difference between
    services and factories are subtle (instantiated as an object, or via a function call) and has more to to do with how the javascript couples to other transpiling javascript systems. Here, the difference is largely irrelevant, where the choice of service versus factory is due to legacy code.


### Layout/style changes

These are quite easy -- generally, all you have to do is modify the required HTML or SASS file. Do NOT edit the CSS files in `source/assets/css`, these are overwritten by SASS!
- To change text on a page, just search for that text and change it. That's all there is.
- To change a style, find the SASS file that defines that class (which can require a little bit of sleuthing). For example, to change the color of the loading bar, you would open `source/sass/main/project/_loading-bar.scss` and change `$loadingcolor`.

### Custom HTML elements

In AngularJS it's a little tricky to define new elements -- there are a lot of things that all have to point to the same place! As a case study, let's look at adding a new custom HTML element along the lines of `<rzslider>`, which adds a slider. Here we will add a help popup. The help popup has two parts: the icon and the popup itself.

0. You need three things: the JavaScript file, the HTML file, and the SASS file. For `rzslider` these are:
  0. JavaScript file: `source/vendor/angularjs-slider/dist/rzslider.min.js`
  0. HTML file: included in the JavaScript in this case, but also `source/vendor/angularjs-slider/src/rzSliderTpl.html`
  0. SASS file: `source/sass/main/rzslider-custom.scss`
0. Copy these to appropriate places, e.g.:
  0. JavaScript file: `source/js/modules/common/helppopup.js`
  0. HTML file: `source/js/modules/common/helppopup-template.html`
  0. SASS file: `source/sass/main/helppopup.scss`
0. Make everything point to the correct places:
  0. SASS: add `@import 'main/helppopup';` to `source/sass/main.scss`
  0. JavaScript:
    0. In `source/js/app.js`, add e.g. `helppopupModule` to _both_ `define` and to `.module('app')`
    0. In `source/js/config.js`, add e.g. `'helppopupModule': './js/modules/common/helppopup',`. Note: the name provided here must match the name provided in `app.js` (e.g. `helppopupModule`), which must also match the module name provided in the JavaScript file, e.g. `var module = angular.module('helppopupModule', [])`.
    0. Make sure the directive's `templateURL` is correct, i.e. `templateUrl: 'js/modules/common/helppopup-template.html',`
  0. The new HTML tag is defined by
